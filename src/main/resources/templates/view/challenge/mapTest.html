<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layout/defaultLayout}" data-theme="corporate">
<head>
    <title>Map Test</title>

    <script type="text/javascript" th:src="'//dapi.kakao.com/v2/maps/sdk.js?appkey=' + ${mapKey}
    + '&libraries=services,clusterer,drawing'"></script>
</head>
<body>
<th:block layout:fragment="Content">
    <main class="flex w-full">
        <div class="flex flex-col justify-center w-full mx-auto py-20 navbar bg-base-100">

            <div>
                <h1> 지도 api 테스트 </h1>
            </div>

            <div>
                <div id="map" class="w-96 h-96" ></div>
            </div>

            <div class="flex flex-col gap-5">
                <button onclick="getCurPosition()" class="btn btn-warning">현재 위치 받아오기</button>
                <button onclick="searchPlace('AT4')" class="btn btn-ghost">주변 관광명소(AT4) 조회하기</button>
                <button onclick="searchPlace('CT1')" class="btn btn-primary">주변 문화시설(CT1) 조회하기</button>
                <button onclick="searchPlace('FD6')" class="btn btn-danger">주변 음식점(FD6) 조회하기</button>
                <button onclick="searchPlace('CE7')" class="btn btn-success">주변 카페(CE7) 조회하기</button>
            </div>

            <div id="addressDiv" class="hidden">
                <h1>hello</h1>
            </div>

            <div id="placeNameDiv" class="hidden">
                <h1>bye</h1>
            </div>

        </div>
    </main>

    <script>

        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(37.49, 126.92), // 지도의 중심좌표
                level: 4 // 지도의 확대 레벨
            };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다
        var ps = new kakao.maps.services.Places(map);

        function searchPlace(code) {

            console.log(code);

            ps.categorySearch(code, placeSearchCB, {useMapBounds:true});
        }

        function placeSearchCB(data, status, pagination) {

            if (status === kakao.maps.services.Status.OK) {
                toastNotice("조회에 성공하였습니다");

                console.log(data);

                var size = 0;

                if(data.length > 10) {
                    size = 10;
                } else {
                    size = data.length;
                }

                var address_name = [];
                var place_name = [];

                for(var i=0; i<size; i++) {
                    address_name[i] = data[i].address_name;
                    place_name[i] = data[i].place_name;
                }

                var addressDiv = document.getElementById("addressDiv");
                var placeNameDiv = document.getElementById("placeNameDiv");

                addressDiv.style.display = 'block';
                placeNameDiv.style.display = 'block';

                console.log(address_name);
                console.log(place_name);


            } else if (status === kakao.maps.services.Status.ZERO_RESULT) {
                toastWarning("주변에 존재하지 않는 것 같아요!");
            } else if (status === kakao.maps.services.Status.ERROR) {
                toastWarning("[ERROR] 옳지 않은 호출입니다.");
            }
        }

        function getCurPosition() {

            // HTML5의 geolocation으로 사용할 수 있는지 확인합니다
            if (navigator.geolocation) {

                // GeoLocation을 이용해서 접속 위치를 얻어옵니다
                navigator.geolocation.getCurrentPosition(function(position) {

                    var lat = position.coords.latitude, // 위도
                        lon = position.coords.longitude; // 경도

                    var locPosition = new kakao.maps.LatLng(lat, lon), // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성합니다
                        message = '<div style="padding:5px;">현재 예상 위치</div>'; // 인포윈도우에 표시될 내용입니다

                    // 마커와 인포윈도우를 표시합니다
                    displayMarker(locPosition, message);

                    // FIXME: 위치 얻기 진행한 뒤 실제로는 드래그 및 확대 불가능. 나중에 주석 해제
                    map.setDraggable(false);
                    map.setZoomable(false);

                });

            } else { // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다

                var locPosition = new kakao.maps.LatLng(37.49, 126.92),
                    message = 'geolocation을 사용할수 없어요..'

                displayMarker(locPosition, message);
            }

            // 지도에 마커와 인포윈도우를 표시하는 함수입니다
            function displayMarker(locPosition, message) {

                // 마커를 생성합니다
                var marker = new kakao.maps.Marker({
                    map: map,
                    position: locPosition
                });

                var iwContent = message, // 인포윈도우에 표시할 내용
                    iwRemoveable = true;

                // 인포윈도우를 생성합니다
                var infowindow = new kakao.maps.InfoWindow({
                    content : iwContent,
                    removable : iwRemoveable
                });

                // 인포윈도우를 마커위에 표시합니다
                infowindow.open(map, marker);

                // 지도 중심좌표를 접속위치로 변경합니다
                map.setCenter(locPosition);
            }

        }
    </script>
</th:block>

</body>
</html>